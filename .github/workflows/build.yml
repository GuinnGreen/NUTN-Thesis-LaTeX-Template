name: Build NUTN Thesis PDF

on:
  push:
    branches: [ "master", "main", "dev" ]
    tags: [ 'v*' ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ "master", "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  # ---------------------------------------------------------
  # Job 1: åˆ¤æ–·è¦ç·¨è­¯å“ªäº›ç‰ˆæœ¬ (å‹•æ…‹çŸ©é™£ç”Ÿæˆ)
  # ---------------------------------------------------------
  check_config:
    runs-on: ubuntu-latest
    outputs:
      # å°‡ç”¢ç”Ÿçš„ JSON è¼¸å‡ºçµ¦ä¸‹ä¸€å€‹ Job ä½¿ç”¨
      degrees: ${{ steps.set-matrix.outputs.degrees }}
      languages: ${{ steps.set-matrix.outputs.languages }}
      modes: ${{ steps.set-matrix.outputs.modes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Build Matrix
        id: set-matrix
        run: |
          IS_OFFICIAL_RELEASE=${{ startsWith(github.ref, 'refs/tags/') && github.repository == 'NUTN-Thesis-LaTeX-Template' }}

          if [ "$IS_OFFICIAL_RELEASE" == "true" ]; then
            echo "ğŸš€ Official Release Detected. Building FULL Matrix..."
            echo "degrees=['master', 'doctor']" >> $GITHUB_OUTPUT
            echo "languages=['chinese', 'english']" >> $GITHUB_OUTPUT
            echo "modes=['final', 'draft']" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”§ User Build Detected (Push/PR/User-Tag). Parsing main.tex..."

            # æŠ“å–è¨­å®š
            PARSED_DEGREE=$(grep -E '^\s*degree\s*=' main.tex | awk -F "=" '{print $2}' | awk -F "," '{print $1}' | tr -d '[:space:]')
            PARSED_LANG=$(grep -E '^\s*language\s*=' main.tex | awk -F "=" '{print $2}' | awk -F "," '{print $1}' | tr -d '[:space:]')

            # å¦‚æœæŠ“ä¸åˆ°ï¼Œå°±è·‘é è¨­å€¼ (ç¢©å£«/ä¸­æ–‡/Final)
            if [[ -z "$PARSED_DEGREE" || -z "$PARSED_LANG" ]]; then
              echo "âš ï¸ Parse failed! Fallback to default (master/chinese)."
              PARSED_DEGREE="master"
              PARSED_LANG="chinese"
            fi

            # è¼¸å‡ºå–®ä¸€çŸ©é™£
            echo "degrees=['$PARSED_DEGREE']" >> $GITHUB_OUTPUT
            echo "languages=['$PARSED_LANG']" >> $GITHUB_OUTPUT
            echo "modes=['final']" >> $GITHUB_OUTPUT
          fi

  # ---------------------------------------------------------
  # Job 2: ç·¨è­¯æ ¸å¿ƒ (ä¾è³´ Job 1 çš„è¼¸å‡º)
  # ---------------------------------------------------------
  build_matrix:
    needs: check_config
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # ä½¿ç”¨å¾ check_config å‚³éä¾†çš„å‹•æ…‹ JSON
        degree: ${{ fromJson(needs.check_config.outputs.degrees) }}
        language: ${{ fromJson(needs.check_config.outputs.languages) }}
        mode: ${{ fromJson(needs.check_config.outputs.modes) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. å‹•æ…‹ä¿®æ”¹åƒæ•¸
      # ---------------------------------------------------------
      - name: Configure main.tex
        run: |
          echo "Configuring for: Degree=${{ matrix.degree }}, Lang=${{ matrix.language }}, Mode=${{ matrix.mode }}"

          # ä¿®æ”¹å­¸ä½
          if [ "${{ matrix.degree }}" == "doctor" ]; then
            sed -i 's/degree\s*=\s*master/degree    = doctor/' main.tex
          elif [ "${{ matrix.degree }}" == "master" ]; then
             sed -i 's/degree\s*=\s*doctor/degree    = master/' main.tex
          fi

          # ä¿®æ”¹èªè¨€
          if [ "${{ matrix.language }}" == "english" ]; then
            sed -i 's/language\s*=\s*chinese/language  = english/' main.tex
          elif [ "${{ matrix.language }}" == "chinese" ]; then
            sed -i 's/language\s*=\s*english/language  = chinese/' main.tex
          fi

          # ä¿®æ”¹ Draft æ¨¡å¼
          if [ "${{ matrix.mode }}" == "draft" ]; then
            sed -i 's/%\s*draft/  draft/' main.tex
          fi

      # ---------------------------------------------------------
      # 2. ç·¨è­¯æ ¸å¿ƒ
      # ---------------------------------------------------------
      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          pre_compile: "mkdir -p ~/.local/share/fonts/ && curl -L -o ~/.local/share/fonts/cwTeXQMing.ttf https://raw.githubusercontent.com/l10n-tw/cwtex-q-fonts-TTFs/master/ttf/cwTeXQMing-Medium.ttf && curl -L -o ~/.local/share/fonts/cwTeXQKai.ttf https://raw.githubusercontent.com/l10n-tw/cwtex-q-fonts-TTFs/master/ttf/cwTeXQKai-Medium.ttf && fc-cache -fv"
          # ä½¿ç”¨ -jobname é¿å…æª”åè¡çªï¼Œä¸¦å¼·åˆ¶ä½¿ç”¨ xelatex
          args: >
            -jobname=${{ matrix.degree }}_${{ matrix.language }}_${{ matrix.mode }}
            -xelatex
            -file-line-error
            -halt-on-error
            -interaction=nonstopmode

      # ---------------------------------------------------------
      # 3. ä¸Šå‚³ç”¢ç‰© (ä¾› Release æˆ– Debug ç”¨)
      # ---------------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.degree }}-${{ matrix.language }}-${{ matrix.mode }}
          path: "*.pdf"
          retention-days: 5

  # ---------------------------------------------------------
  # Release Job (åªæœ‰æ‰“ Tag æ™‚æ‰æœƒåŸ·è¡Œ)
  # ---------------------------------------------------------
  release:
    needs: build_matrix
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true # å°‡æ‰€æœ‰çŸ©é™£ç”¢ç”Ÿçš„ PDF åˆä½µåˆ°åŒä¸€è³‡æ–™å¤¾

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
